{
  "title": "Storage & Queue Health",
  "tags": [
    "storage",
    "queue",
    "rabbitmq",
    "minio"
  ],
  "timezone": "browser",
  "schemaVersion": 16,
  "version": 0,
  "refresh": "10s",
  "panels": [
    {
      "id": 1,
      "title": "RabbitMQ Queue Size (Messages Ready)",
      "type": "timeseries",
      "gridPos": {
        "h": 8,
        "w": 12,
        "x": 0,
        "y": 0
      },
      "targets": [
        {
          "expr": "rabbitmq_queue_messages_ready{queue=~\"extract|transform|clean\"}",
          "legendFormat": "{{queue}}",
          "refId": "A",
          "datasource": {
            "type": "prometheus",
            "uid": "prometheus"
          }
        }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "short",
          "nullValueMode": "null"
        }
      },
      "description": "Number of messages waiting in each queue"
    },
    {
      "id": 2,
      "title": "RabbitMQ Messages Published vs Consumed",
      "type": "timeseries",
      "gridPos": {
        "h": 8,
        "w": 12,
        "x": 12,
        "y": 0
      },
      "targets": [
        {
          "expr": "sum(rate(rabbitmq_queue_messages_published_total{queue=~\"extract|transform|clean\"}[15m])) by (queue)",
          "legendFormat": "Published ({{queue}})",
          "refId": "A",
          "datasource": {
            "type": "prometheus",
            "uid": "prometheus"
          }
        },
        {
          "expr": "sum(rate(rabbitmq_queue_messages_delivered_total{queue=~\"extract|transform|clean\"}[15m])) by (queue)",
          "legendFormat": "Consumed ({{queue}})",
          "refId": "B",
          "datasource": {
            "type": "prometheus",
            "uid": "prometheus"
          }
        }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "ops",
          "nullValueMode": "null"
        }
      },
      "description": "Message throughput: published vs consumed per second"
    },
    {
      "id": 9,
      "title": "RabbitMQ Unacked Messages",
      "type": "timeseries",
      "gridPos": {
        "h": 8,
        "w": 12,
        "x": 0,
        "y": 8
      },
      "targets": [
        {
          "expr": "rabbitmq_queue_messages_unacked{queue=~\"extract|transform|clean\"}",
          "legendFormat": "Unacked ({{queue}})",
          "refId": "A",
          "datasource": {
            "type": "prometheus",
            "uid": "prometheus"
          }
        }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "short",
          "nullValueMode": "null"
        }
      },
      "description": "Messages being processed but not yet acknowledged"
    },
    {
      "id": 3,
      "title": "MinIO Total Object Count",
      "type": "timeseries",
      "gridPos": {
        "h": 8,
        "w": 12,
        "x": 12,
        "y": 8
      },
      "targets": [
        {
          "expr": "minio_cluster_usage_object_total",
          "legendFormat": "Total Objects",
          "refId": "A",
          "datasource": {
            "type": "prometheus",
            "uid": "prometheus"
          }
        }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "short",
          "nullValueMode": "null"
        }
      },
      "description": "Total number of objects stored in MinIO cluster (across all buckets)"
    },
    {
      "id": 4,
      "title": "MinIO Total Storage Used",
      "type": "timeseries",
      "gridPos": {
        "h": 8,
        "w": 12,
        "x": 0,
        "y": 16
      },
      "targets": [
        {
          "expr": "minio_cluster_usage_total_bytes",
          "legendFormat": "Total Bytes",
          "refId": "A",
          "datasource": {
            "type": "prometheus",
            "uid": "prometheus"
          }
        }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "bytes",
          "nullValueMode": "null"
        }
      },
      "description": "Total size of all objects in MinIO cluster (across all buckets)"
    },
    {
      "id": 5,
      "title": "MinIO Cluster Bucket Count",
      "type": "stat",
      "gridPos": {
        "h": 8,
        "w": 6,
        "x": 12,
        "y": 16
      },
      "targets": [
        {
          "expr": "minio_cluster_bucket_total",
          "refId": "A",
          "datasource": {
            "type": "prometheus",
            "uid": "prometheus"
          }
        }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "short"
        }
      }
    },
    {
      "id": 6,
      "title": "MinIO Capacity Usage",
      "type": "gauge",
      "gridPos": {
        "h": 8,
        "w": 6,
        "x": 18,
        "y": 16
      },
      "targets": [
        {
          "expr": "(1 - (minio_cluster_capacity_raw_free_bytes / minio_cluster_capacity_raw_total_bytes)) * 100",
          "refId": "A",
          "datasource": {
            "type": "prometheus",
            "uid": "prometheus"
          }
        }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "percent",
          "min": 0,
          "max": 100
        }
      },
      "description": "Percentage of MinIO storage capacity used"
    },
    {
      "id": 7,
      "title": "Rows in Gold Database (DuckDB)",
      "type": "stat",
      "gridPos": {
        "h": 8,
        "w": 6,
        "x": 0,
        "y": 24
      },
      "targets": [
        {
          "expr": "cleaner_rows_processed_total",
          "refId": "A",
          "datasource": {
            "type": "prometheus",
            "uid": "prometheus"
          }
        }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "short"
        }
      },
      "description": "Total rows processed and written to DuckDB Gold table"
    },
    {
      "id": 10,
      "title": "DuckDB Write Duration (avg)",
      "type": "stat",
      "gridPos": {
        "h": 8,
        "w": 6,
        "x": 6,
        "y": 24
      },
      "targets": [
        {
          "expr": "(increase(cleaner_duckdb_write_duration_seconds_sum[15m]) / increase(cleaner_duckdb_write_duration_seconds_count[15m])) or vector(0)",
          "refId": "A",
          "datasource": {
            "type": "prometheus",
            "uid": "prometheus"
          }
        }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "s",
          "decimals": 3
        }
      },
      "description": "Average time to write data to DuckDB Gold table"
    },
    {
      "id": 8,
      "title": "Custom: MinIO Free Space Percentage",
      "type": "gauge",
      "gridPos": {
        "h": 8,
        "w": 12,
        "x": 12,
        "y": 24
      },
      "targets": [
        {
          "expr": "(minio_cluster_capacity_raw_free_bytes / minio_cluster_capacity_raw_total_bytes) * 100",
          "refId": "A",
          "datasource": {
            "type": "prometheus",
            "uid": "prometheus"
          }
        }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "percent",
          "min": 0,
          "max": 100,
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "value": 0,
                "color": "red"
              },
              {
                "value": 10,
                "color": "yellow"
              },
              {
                "value": 20,
                "color": "green"
              }
            ]
          }
        }
      },
      "description": "Custom metric: Percentage of free storage space remaining in MinIO (alert if < 10%)"
    }
  ]
}
